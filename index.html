<html>
    <head>
        <script src="https://cdn.jsdelivr.net/pouchdb/5.4.5/pouchdb.min.js"></script>
        <script>
            const nutrientsDb = new PouchDB('nutrients')
            nutrientsDb.changes({ since: 0, include_docs: true })
                .then(changes => applyChanges(changes.results))

            window.onload = () => {
                document.querySelector('[type="submit"][value="Save"]')
                    .addEventListener('click', onSaveClicked)
            }
            async function onSaveClicked (e) {
                e.preventDefault()
                await setNutrient(e.target.parentNode)
                window.location = window.location.toString().replace('#new', '')
            }
            async function setNutrient (form) {                
                const [name, id, _rev, carbsStr] = ['name', 'id', 'rev', 'carbs']
                    .map(n => form.querySelector(`[name="${n}"]`).value)
                const carbs = Number.parseFloat(carbsStr)
                const _id = id || new Date().toISOString()
                await nutrientsDb.put({ _id, _rev, name, carbs })
            }
            function applyChanges (changes) {
                for (const c of changes) addToTable(c)
            }
            function addToTable ({ id, doc: { name, carbs }, changes }) {
                const data = { id, rev: changes.pop().rev, name, carbs }
                const newRow = document.querySelector('#newNutrient form').cloneNode(true)

                Object.keys(data).forEach(k => newRow
                    .querySelector(`[name="${k}"]`)
                    .setAttribute('value', data[k]))
                newRow.querySelector('[type="submit"][value="Save"]')
                    .addEventListener('click', onSaveClicked)
                newRow.querySelector('a').remove()
                document.getElementById('index').appendChild(newRow)
            }
        </script>
        <style>
            #new:target #index { display: none }
            #new:target #newNutrient { display: block }
            #new:target #newNutrient a { display: inline; }
            #newNutrient { display: none; }
            #index { display: table; }
            #index > * { display:table-row; visibility:visible; }
            #index > * > * { display:table-cell; }
            #index label > span { display: none; }
        </style>
    </head>
    <body id="new">
        <div id="index">
            <h1>Nutrients</h1>
            <div hidden>
                <div>name</div>
                <div>carbs</div>
                <div><a href="#new">new</a></div>
            </div>
        </div>
        <div id="newNutrient">
            <h1>New nutrient</h1>
            <form>
                <input name="id" type="hidden">
                <input name="rev" type="hidden">
                <label><span>Name</span><input name="name" type="text"></label>
                <label><span>Carbs</span><input name="carbs" type="number"></label>
                <a href="#" hidden>Back</a>
                <input type="submit" value="Save">
            </form>
        </div>
    </body>
</html>